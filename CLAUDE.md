# kinder

The name kinder when used in code should be referred to via a variable to allow for easy changes in the future.

This project is a tool to stand up a local kind cluster and support services. The runtime environment consists of:

- Docker CE or Docker Desktop
- A Kind cluster (managed via `kinder kind` commands):
  - Trusts the kinder CA certificate for HTTPS connections
  - Uses Zot registry as a pull-through cache for container images
  - Connected to the kinder Docker network for service communication
  - Configurable worker node count (default: control-plane only)
- Docker containers running the following services:
  - **Step CA** certificate authority with ACME support
    - Accessible at `https://ca.c0000201.sslip.io:8443` (or custom domain) via Traefik with ACME certificate
    - The root certificate is auto-generated using ECDSA with a 1-year validity
    - Certificate has name constraints for: the sslip.io domain (and subdomains), localhost (and subdomains), and the stepca container name
    - ACME provisioner enabled for automatic certificate issuance
    - Intermediate CA certificate is generated from the root CA
  - **Zot registry** with UI and mirror support
    - Available at `http://localhost:5000` (direct) and `https://registry.c0000201.sslip.io:8443` (via Traefik)
    - Configured as pull-through cache for: ghcr.io, registry-1.docker.io, quay.io, registry.k8s.io
    - UI and search extensions enabled
  - **Gatus** health dashboard
    - Accessible at `https://gatus.c0000201.sslip.io:8443`
    - Monitors Step CA and Zot registry health
    - Configured to trust the root CA certificate for HTTPS health checks
  - **Traefik** reverse proxy
    - Dashboard at `https://traefik.c0000201.sslip.io:8443` (or custom domain)
    - HTTPS services at configurable port (default 8443, `--traefik-port`)
    - HTTP to HTTPS redirect on port 80 (except for ACME challenges)
    - Uses ACME HTTP-01 challenge to obtain certificates from Step CA
    - Trusts the root CA certificate for verifying backend HTTPS connections to Step CA
    - Terminates TLS for all services including Step CA
    - All services use sslip.io domain (default `c0000201.sslip.io`, configurable via `--traefik-domain`)

All services communicate using Docker short names (stepca, zot, gatus, traefik) on the `kind` Docker bridge network (named `kindbr0`).

The network uses `172.28.28.0/24` with container DHCP limited to `172.28.28.0/25`, reserving `172.28.28.128-255` for MetalLB.

It is written in idiomatic Go as a CLI tool with command-line completion support using the Cobra library.

## Usage

Start all services: `kinder start`

The CA certificate is automatically generated on first start if it doesn't exist.

Files generated by kinder are stored in `$XDG_DATA_HOME/kinder` (or `~/.local/share/kinder` if XDG_DATA_HOME is not set).

## Bootstrap Process

1. Check for CA certificate, generate if missing (auto-generated with domain constraints)
2. Create Docker network `kind` with bridge `kindbr0`
3. Start Step CA (with ACME enabled and intermediate CA)
4. Start Zot Registry (with mirrors and UI)
5. Start Gatus health dashboard
6. Start Traefik reverse proxy (obtains ACME certs from Step CA)

## Configuration

Configuration is managed using Viper with the following precedence (highest to lowest):
1. CLI flags (e.g., `--traefik-port 9443`)
2. Environment variables (e.g., `KINDER_TRAEFIK_PORT=9443`)
3. Config file (`$XDG_CONFIG_HOME/kinder/config.yaml`)
4. Built-in defaults

### Config File

Location: `~/.config/kinder/config.yaml` (or `$XDG_CONFIG_HOME/kinder/config.yaml`)

Example config file:
```yaml
appName: kinder
domain: c0000201.sslip.io
network:
  name: kind
  cidr: 172.28.28.0/24
  bridge: kindbr0
traefik:
  port: "8443"
argocd:
  version: v3.1.10
  manifestURL: https://raw.githubusercontent.com/org/gitops/main/app-of-apps.yaml
images:
  stepca: smallstep/step-ca:latest
  zot: ghcr.io/project-zot/zot-linux-amd64:latest
  gatus: twinproduction/gatus:latest
  traefik: traefik:latest
registryMirrors:
  - ghcr.io
  - registry-1.docker.io
  - quay.io
  - registry.k8s.io
```

### Environment Variables

All config keys can be set via environment variables with `KINDER_` prefix:
- `KINDER_DATADIR` - Data directory path (CA certs, container configs)
- `KINDER_DOMAIN` - Base domain for services
- `KINDER_TRAEFIK_PORT` - HTTPS port
- `KINDER_NETWORK_NAME` - Docker network name
- `KINDER_NETWORK_CIDR` - Network CIDR
- `KINDER_IMAGES_STEPCA` - Step CA image
- `KINDER_IMAGES_ZOT` - Zot registry image
- `KINDER_ARGOCD_VERSION` - ArgoCD version to install (default: v3.1.10)
- `KINDER_ARGOCD_MANIFESTURL` - URL to fetch app-of-apps manifest (default: https://raw.githubusercontent.com/mattwillsher/kinder-argo/refs/heads/main/root-app.yaml)

### CLI Flags

- `--config`: Path to config file (overrides default location)
- `--data-dir`: Path to data directory (default: $XDG_DATA_HOME/kinder)
- `--traefik-port`: HTTPS port for Traefik (default: 8443)
- `--traefik-domain`: Base domain for services (default: c0000201.sslip.io)
- `--network`: Docker network name (default: kind)
- `--cidr`: Network CIDR (default: 172.28.28.0/24)

## Browser Certificate Trust

To access services via HTTPS in a web browser without security warnings, import the root CA certificate into your browser's certificate authorities:

1. Locate the root CA certificate at `$XDG_DATA_HOME/kinder/ca.crt` (typically `~/.local/share/kinder/ca.crt`)
2. Import into your browser:
   - **Firefox**: Settings → Privacy & Security → Certificates → View Certificates → Authorities → Import
   - **Chrome/Edge**: Settings → Privacy and security → Security → Manage certificates → Authorities → Import
   - **Safari**: Open the file and add to Keychain, then mark as trusted for SSL

After importing, all services at `*.c0000201.sslip.io:8443` will show as secure.

## Commands

- `kinder start`: Start all services
- `kinder stop`: Stop all services and remove network
- `kinder restart`: Restart services with updated configurations
- `kinder status`: Show status of CA, network, and containers
- `kinder clean`: Remove all configuration and data (doesn't stop containers)
- `kinder diagnostics`: Run comprehensive diagnostics to verify environment
- `kinder ca generate`: Generate CA certificate manually
- `kinder ca print`: Display CA certificate information
- `kinder config show`: Display current configuration as YAML (useful for creating config files)
- `kinder config path`: Show config file location and status
- `kinder config init`: Create a default config file
- `kinder kind start`: Create Kind cluster with CA trust and registry mirrors
- `kinder kind stop`: Delete the Kind cluster
- `kinder kind status`: Show Kind cluster status and nodes
- `kinder kind kubeconfig`: Print kubeconfig for kubectl access

### Diagnostics

The `kinder diagnostics` command performs comprehensive health checks:

1. **Docker Availability**: Verifies Docker daemon is running and accessible
2. **IP Routability**: Verifies 192.0.2.1 is routable (uses UDP dial, no root required)
3. **CA Certificate**: Checks existence and validity of root CA certificate
4. **Network**: Verifies kinder Docker network exists
5. **Containers**: Confirms all required containers are running (Step CA, Zot, Gatus, Traefik)
6. **Service Endpoints**: Tests all service URLs and validates HTTP responses:
   - Zot Registry (direct at localhost:5000)
   - Step CA (https://ca.{domain}:{port})
   - Zot Registry (https://registry.{domain}:{port})
   - Gatus Dashboard (https://gatus.{domain}:{port})
   - Traefik Dashboard (https://traefik.{domain}:{port})

Run `kinder diagnostics` after `kinder start` to verify everything is working correctly.

### Kind Cluster

The `kinder kind start` command creates a Kind (Kubernetes IN Docker) cluster configured to:

1. **Trust the CA Certificate**: The root CA is mounted to cluster nodes at:
   - `/etc/ssl/certs/kinder-ca.crt` - System-wide trust
   - `/etc/containerd/certs.d/zot:5000/ca.crt` - Registry-specific trust

2. **Use Zot as Pull-Through Cache**: Containerd is configured to redirect pulls from:
   - `docker.io` → `http://zot:5000`
   - `ghcr.io` → `http://zot:5000`
   - `quay.io` → `http://zot:5000`
   - `registry.k8s.io` → `http://zot:5000`

3. **Connect to Kinder Network**: Cluster nodes are connected to the kinder Docker network, enabling direct communication with services (stepca, zot, gatus, traefik).

**Flags:**
- `--workers N`: Number of worker nodes (default: 0, control-plane only)
- `--node-image IMAGE`: Kind node image (default: `kindest/node:v1.32.2`)

**Example:**
```bash
# Start kinder services first
kinder start

# Create Kind cluster with 2 workers
kinder kind start --workers 2

# Get kubeconfig
kinder kind kubeconfig > ~/.kube/kinder-config
export KUBECONFIG=~/.kube/kinder-config

# Verify cluster
kubectl get nodes
```

## Recent Changes (2025-12-26)

### Removed Services
- **Wireguard**: Removed wireguard container and all configuration
- **CoreDNS**: Removed CoreDNS container - services communicate via Docker's internal DNS using short names

### Certificate and TLS Improvements
- **Step CA TLS**: Changed from TCP passthrough to Traefik TLS termination with ACME certificate
  - Step CA now accessible with properly signed certificate matching the domain
  - Fixes browser certificate errors (SEC_ERROR_BAD_DER)
- **CA Trust Configuration**:
  - Gatus: Mounted root CA certificate at `/etc/ssl/certs/kinder-ca.crt` for HTTPS health checks to Step CA
  - Traefik: Uses `SSL_CERT_FILE=/etc/traefik/ca.crt` environment variable to trust root CA for backend HTTPS connections
  - Both services now properly verify Step CA's self-signed backend certificate instead of using insecureSkipVerify

### Architecture Changes
- **Container Hostnames**: All containers use short Docker names (stepca, zot, gatus, traefik)
- **Domain Strategy**: User-facing domains use sslip.io (e.g., ca.c0000201.sslip.io)
- **Service Discovery**: Containers communicate via Docker bridge network DNS, not external domains
- **Traefik Configuration**:
  - HTTP-01 ACME challenge for certificate acquisition
  - HTTP to HTTPS redirect (except for ACME validation)
  - TLS termination for all services
  - InsecureSkipVerify for Step CA backend (Step CA uses self-signed cert internally)

### Code Organization
- Split main.go into modular files:
  - `main.go` - Root command, init(), flag definitions, start/stop/restart/clean commands
  - `config.go` - Config struct and buildConfigFromFlags(), Viper integration
  - `config_commands.go` - `kinder config` subcommands (show, path, init)
  - `ca_commands.go` - `kinder ca` subcommands (generate, print)
  - `network_commands.go` - `kinder network` subcommands
  - `service_commands.go` - Individual service start/stop commands
  - `container_commands.go` - Container lifecycle management
  - `diagnostics_commands.go` - `kinder diagnostics` command
  - `status_commands.go` - `kinder status` command showing CA, network, container, and Kind cluster status
  - `kind_commands.go` - `kinder kind` subcommands (start, stop, status, kubeconfig)
  - `util.go` - Helper functions (getDataDir, cleanContainerData)
- Packages:
  - `config/` - Viper-based configuration management (Initialize, Get, Set, key constants)
  - `docker/` - Docker client wrapper and container/network operations
    - `docker/kind.go` - Kind cluster management (StartKind, StopKind, buildKindConfig, containerd patches)
  - `cacert/` - CA certificate generation

### New Features
- **Diagnostics Command**: Added comprehensive `kinder diagnostics` command
  - Checks Docker availability
  - Verifies IP 192.0.2.1 reachability
  - Validates CA certificate trust
  - Tests all service endpoints with HTTP status codes
  - Provides clear pass/fail reporting

### Test Updates
- Updated all tests to reflect removal of CoreDNS and Wireguard
- Fixed hostname tests to use short names
- Updated Traefik tests for new ACME configuration
- Updated Gatus tests for new service URLs
- All tests passing

---

## Security Notes

This tool is designed for **local development only**. The following trade-offs are made for convenience:

### Network Binding (0.0.0.0)
Services bind to `0.0.0.0` (all interfaces) rather than `127.0.0.1` because:
- The sslip.io domain resolves to `192.0.2.1` (TEST-NET-1), requiring non-loopback access
- Kind cluster nodes need to reach services from the Docker network
- Browser access via the configured domain requires external binding

**Mitigation**: Ensure your host firewall blocks external access to ports 5000 (Zot), 8443 (Traefik), and 80 (HTTP redirect).

### CA Private Key Password
The intermediate CA private key uses an empty password for simplicity:
- File permissions are restricted to 0600 (owner read/write only)
- The key is stored in `$XDG_DATA_HOME/kinder/stepca/secrets/`
- Any process running as your user can access this key

**Mitigation**: This is acceptable for local development certificates. Never use kinder-generated certificates in production.

### Registry Authentication
The Zot registry has no authentication enabled:
- Any process on the network can push/pull images
- This is intentional for local development convenience

**Mitigation**: Firewall external access to port 5000.

### Registry Mirror Image Collisions
The Zot pull-through cache does not namespace images by upstream registry:
- Images from all mirrored registries (docker.io, ghcr.io, quay.io, registry.k8s.io) are cached in a single namespace
- If two registries have images with identical names, only one will be cached
- Zot will pull from the first matching upstream and cache that version

**Mitigation**: This is rarely an issue in practice since registries use different naming conventions:
- Docker Hub: `library/*` for official images, `user/repo` for others
- GHCR: `org/repo` format
- Quay.io: `org/repo` format
- registry.k8s.io: Kubernetes-specific paths

If you need strict registry isolation, pull images directly from upstream instead of through the cache.

---

## Development Guide

### Key Patterns

**Adding a new CLI command:**
1. Create `<feature>_commands.go` with command definitions
2. Add subcommands to parent in `main.go`'s `init()` function
3. Follow existing pattern: parent command + subcommands (e.g., `caCmd` + `generateCmd`, `printCmd`)

**Adding configuration options:**
1. Add key constant in `config/config.go` (e.g., `KeyNewOption = "section.option"`)
2. Add default in `setDefaults()` function
3. Add field to `FileConfig` struct with `mapstructure` and `yaml` tags
4. Environment variable is auto-bound: `KINDER_SECTION_OPTION`

**Container configuration:**
- Container configs are in `docker/` package (e.g., `docker/zot.go`, `docker/traefik.go`)
- Each has a `<Service>Config` struct and `Start<Service>`/`generate<Service>Config` functions
- Config generation writes files to data directory, then mounts into container

### File Locations

| Purpose | Location |
|---------|----------|
| Data files (CA cert, container configs) | `$XDG_DATA_HOME/kinder/` (~/.local/share/kinder/) |
| Config file | `$XDG_CONFIG_HOME/kinder/config.yaml` (~/.config/kinder/) |
| Default constants | `config/config.go` (images, ports, CIDRs) |
| Docker client | `docker/client.go` (shared singleton) |
| Container names | `docker/*.go` (e.g., `StepCAContainerName`) |

### Testing

- Run all tests: `go test ./...`
- **Test isolation**: Tests automatically use a temp data directory (set via `KINDER_DATADIR` in `TestMain`)
  - This prevents tests from modifying the real CA cert or configs in `~/.local/share/kinder`
- Docker integration tests use real Docker daemon
- Network tests: use unique CIDRs to avoid conflicts (e.g., `172.31.255.0/24`)
- Config tests: set/unset env vars carefully to avoid test pollution
- For development, use `KINDER_DATADIR=/tmp/kinder-dev` to keep dev data separate

### Common Tasks

**Change a default value:** Edit `config/config.go` constants and `setDefaults()`

**Add a new service container:**
1. Create `docker/<service>.go` with config struct and start/stop functions
2. Add container name constant
3. Add to `container_commands.go` for CLI access
4. Add to `main.go` start/stop/restart sequences
5. Add to diagnostics checks

**Modify Traefik routing:** Edit `docker/traefik.go` - `generateTraefikDynamicConfig()` for routes, `generateTraefikStaticConfig()` for entrypoints/ACME
